@page
@model SBooks.Pages.Profile.IndexModel
@{
    ViewData["Title"] = "Thông tin cá nhân";
}

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="avatar-circle">
                            @{
                                var initials = !string.IsNullOrEmpty(Model.Profile.FullName) 
                                    ? Model.Profile.FullName.Split(' ').Select(x => x[0]).Take(2) 
                                    : Model.Profile.Username.Take(2);
                            }
                            <span>@string.Join("", initials).ToUpper()</span>
                        </div>
                    </div>
                    <h5>@Model.Profile.FullName</h5>
                    <p class="text-muted">@@@Model.Profile.Username</p>
                    <small class="text-muted">
                        Tham gia từ @(Model.Profile.CreatedAt?.ToString("dd/MM/yyyy") ?? "N/A")
                    </small>
                </div>
            </div>

            <!-- Navigation -->
            <div class="card mt-3">
                <div class="list-group list-group-flush">
                    <a href="#overview" class="list-group-item list-group-item-action active" data-bs-toggle="tab">
                        <i class="fas fa-user me-2"></i>Tổng quan
                    </a>
                    <a href="#favorites" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-heart me-2"></i>Sách yêu thích 
                        <span class="badge bg-primary rounded-pill">@Model.Profile.FavoriteBooksCount</span>
                    </a>
                    <a href="#top-books" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-trophy me-2"></i>Top sách yêu thích
                        <span class="badge bg-warning rounded-pill">TOP 10</span>
                    </a>
                    <a href="#reviews" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-star me-2"></i>Đánh giá của tôi
                        <span class="badge bg-success rounded-pill">@Model.Profile.ReviewsCount</span>
                    </a>
                    <a href="#search-history" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-search me-2"></i>Lịch sử tìm kiếm
                    </a>
                    @if (User.IsAdmin())
                    {
                        <a href="#added-books" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                            <i class="fas fa-plus-circle me-2"></i>Sách đã thêm
                            <span class="badge bg-info rounded-pill">@(Model.Profile.BooksAddedCount ?? 0)</span>
                        </a>
                    }
                    <a href="#settings" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-cog me-2"></i>Cài đặt
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line me-2"></i>Thống kê tổng quan</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 border rounded">
                                        <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                                        <h4>@Model.Profile.FavoriteBooksCount</h4>
                                        <small class="text-muted">Sách yêu thích</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 border rounded">
                                        <i class="fas fa-star fa-2x text-warning mb-2"></i>
                                        <h4>@Model.Profile.ReviewsCount</h4>
                                        <small class="text-muted">Đánh giá</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 border rounded">
                                        <i class="fas fa-reply fa-2x text-info mb-2"></i>
                                        <h4>@Model.Profile.RepliesCount</h4>
                                        <small class="text-muted">Phản hồi</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 border rounded">
                                        <i class="fas fa-search fa-2x text-success mb-2"></i>
                                        <h4>@Model.Profile.SearchHistoryCount</h4>
                                        <small class="text-muted">Lần tìm kiếm</small>
                                    </div>
                                </div>
                            </div>

                            @if (User.IsAdmin())
                            {
                                <hr>
                                <h6><i class="fas fa-shield-alt me-2"></i>Thống kê quản trị</h6>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="stat-card text-center p-3 border rounded">
                                            <i class="fas fa-book fa-2x text-primary mb-2"></i>
                                            <h4>@(Model.Profile.BooksAddedCount ?? 0)</h4>
                                            <small class="text-muted">Sách đã thêm</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card text-center p-3 border rounded">
                                            <i class="fas fa-eye fa-2x text-info mb-2"></i>
                                            <h4>@(Model.Profile.TotalViewsOfAddedBooks ?? 0)</h4>
                                            <small class="text-muted">Lượt xem tổng</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card text-center p-3 border rounded">
                                            <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                                            <h4>@(Model.Profile.TotalFavoritesOfAddedBooks ?? 0)</h4>
                                            <small class="text-muted">Lượt yêu thích</small>
                                        </div>
                                    </div>
                                </div>
                            }

                            <div class="mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body">
                                                <h6><i class="fas fa-clock me-2"></i>Thông tin tài khoản</h6>
                                                <p class="mb-1"><strong>Email:</strong> @Model.Profile.Email</p>
                                                <p class="mb-1"><strong>Trạng thái:</strong> 
                                                    @if (Model.Profile.IsActive == true)
                                                    {
                                                        <span class="badge bg-success">Đang hoạt động</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Bị khóa</span>
                                                    }
                                                </p>
                                                @if (Model.Profile.LastLoginTime.HasValue)
                                                {
                                                    <p class="mb-0"><strong>Lần đăng nhập cuối:</strong> @Model.Profile.LastLoginTime.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Favorites Tab -->
                <div class="tab-pane fade" id="favorites">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-heart me-2"></i>Sách yêu thích</h5>
                            <span class="badge bg-primary">@Model.Profile.FavoriteBooksCount cuốn</span>
                        </div>
                        <div class="card-body">
                            <div id="favorite-books-container">
                                @await Html.PartialAsync("_FavoriteBooks", Model.FavoriteBooks)
                            </div>
                            @if (Model.FavoriteBooks.Count >= 6)
                            {
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary" onclick="loadMoreFavorites()">
                                        Xem thêm
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Top Books Tab -->
                

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-star me-2"></i>Đánh giá và bình luận của tôi</h5>
                        </div>
                        <div class="card-body">
                            @if (Model.RecentReviews.Any())
                            {
                                <div class="list-group">
                                    @foreach (var review in Model.RecentReviews)
                                    {
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6>
                                                        <a href="/Books/Details/@review.BookId" class="text-decoration-none">
                                                            @review.Book.Title
                                                        </a>
                                                    </h6>
                                                    @if (review.Rating.HasValue)
                                                    {
                                                        <div class="mb-2">
                                                            @for (int i = 1; i <= 5; i++)
                                                            {
                                                                <i class="fas fa-star @(i <= review.Rating ? "text-warning" : "text-muted")"></i>
                                                            }
                                                            <span class="ms-1">(@review.Rating/5 sao)</span>
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(review.CommentText))
                                                    {
                                                        <p class="mb-1">@review.CommentText</p>
                                                    }
                                                    @if (review.ParentReviewId.HasValue)
                                                    {
                                                        <small class="text-muted">
                                                            <i class="fas fa-reply me-1"></i>Phản hồi bình luận
                                                        </small>
                                                    }
                                                </div>
                                                <div class="ms-3">
                                                    <small class="text-muted">@review.CreatedAt?.ToString("dd/MM/yyyy")</small>
                                                    <div class="mt-1">
                                                        <span class="badge bg-success me-1">
                                                            <i class="fas fa-thumbs-up"></i> @(review.LikeCount ?? 0)
                                                        </span>
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-thumbs-down"></i> @(review.DislikeCount ?? 0)
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Bạn chưa có đánh giá nào</p>
                                    <a href="/" class="btn btn-primary">Khám phá sách</a>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Search History Tab -->
                <div class="tab-pane fade" id="search-history">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-search me-2"></i>Lịch sử tìm kiếm</h5>
                        </div>
                        <div class="card-body">
                            @if (Model.RecentSearches.Any())
                            {
                                <div class="list-group">
                                    @foreach (var search in Model.RecentSearches)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@search.SearchText</strong>
                                                <br>
                                                <small class="text-muted">
                                                    @search.SearchTime?.ToString("dd/MM/yyyy HH:mm")
                                                </small>
                                            </div>
                                            <a href="/?SearchQuery=@Uri.EscapeDataString(search.SearchText)" class="btn btn-outline-primary btn-sm">
                                                Tìm lại
                                            </a>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Chưa có lịch sử tìm kiếm</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Added Books Tab (Admin only) -->
                @if (User.IsAdmin())
                {
                    <div class="tab-pane fade" id="added-books">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-plus-circle me-2"></i>Sách đã thêm</h5>
                                <span class="badge bg-info">@(Model.Profile.BooksAddedCount ?? 0) cuốn</span>
                            </div>
                            <div class="card-body">
                                <div id="added-books-container">
                                    @await Html.PartialAsync("_AddedBooks", Model.AddedBooks)
                                </div>
                                @if (Model.AddedBooks.Count >= 6)
                                {
                                    <div class="text-center mt-3">
                                        <button class="btn btn-outline-info" onclick="loadMoreAddedBooks()">
                                            Xem thêm
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cog me-2"></i>Cài đặt tài khoản</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" asp-page-handler="UpdateProfile">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="UpdateProfile.FullName" class="form-label">Họ và tên</label>
                                            <input asp-for="UpdateProfile.FullName" class="form-control" />
                                            <span asp-validation-for="UpdateProfile.FullName" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="UpdateProfile.Email" class="form-label">Email</label>
                                            <input asp-for="UpdateProfile.Email" class="form-control" />
                                            <span asp-validation-for="UpdateProfile.Email" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Cập nhật thông tin
                                </button>
                            </form>

                            <hr>

                            <div class="mt-4">
                                <h6>Bảo mật</h6>
                                <p class="text-muted">Thay đổi mật khẩu của bạn</p>
                                <a href="/Auth/ChangePassword" class="btn btn-outline-warning">
                                    <i class="fas fa-key me-2"></i>Đổi mật khẩu
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let favoritePage = 1;
        let addedBooksPage = 1;

        function loadMoreFavorites() {
            favoritePage++;
            $.get('/Profile?handler=LoadFavoriteBooks&page=' + favoritePage)
                .done(function(data) {
                    $('#favorite-books-container').append(data);
                })
                .fail(function() {
                    alert('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function loadMoreAddedBooks() {
            addedBooksPage++;
            $.get('/Profile?handler=LoadAddedBooks&page=' + addedBooksPage)
                .done(function(data) {
                    $('#added-books-container').append(data);
                })
                .fail(function() {
                    alert('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function removeFavorite(bookId) {
            if (confirm('Bạn có chắc muốn xóa sách này khỏi danh sách yêu thích?')) {
                $.post('/Profile?handler=RemoveFavorite', { bookId: bookId })
                    .done(function(response) {
                        if (response.success) {
                            $(`[data-book-id="${bookId}"]`).fadeOut(300, function() {
                                $(this).remove();
                            });
                            showAlert('success', response.message);
                        } else {
                            showAlert('danger', response.message);
                        }
                    })
                    .fail(function() {
                        showAlert('danger', 'Có lỗi xảy ra');
                    });
            }
        }

        function showAlert(type, message) {
            const alert = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('.container-fluid').prepend(alert);
        }

        // Show success/error messages
        @if (TempData["SuccessMessage"] != null)
        {
            <text>showAlert('success', '@TempData["SuccessMessage"]');</text>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <text>showAlert('danger', '@TempData["ErrorMessage"]');</text>
        }
    </script>
}

@section Styles {
    <style>
        .avatar-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .list-group-item-action:hover {
            background-color: #f8f9fa;
        }

        .nav-pills .nav-link.active {
            background-color: #007bff;
        }

        /* Top Books Styles */
        .top-book-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e0e0e0;
        }

        .top-book-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .top-book-card.border-warning {
            border-width: 2px !important;
            box-shadow: 0 2px 10px rgba(255, 193, 7, 0.3);
        }

        .rank-badge {
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
        }

        .stats-row {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px 4px;
            margin-top: 8px;
        }

        .top-book-card .card-title a:hover {
            color: #007bff !important;
        }
    </style>
}